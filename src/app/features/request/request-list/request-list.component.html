<div class="request-list-page">
    <div class="header">
        <h2 class="header-title">รายการคำร้องเรียน</h2>

        <!-- Optional: Add Refresh Button -->
        <button mat-icon-button (click)="fetchRequests()" color="primary" [disabled]="loading()">
            <mat-icon>refresh</mat-icon>
        </button>
    </div>

    <div class="filters">
        <mat-form-field appearance="outline">
            <mat-label>สถานะ</mat-label>
            <mat-select [ngModel]="statusFilter()" (ngModelChange)="statusFilter.set($event); onFilterChange()">
                <mat-option value="">ทั้งหมด</mat-option>
                <mat-option value="pending">รอดำเนินการ</mat-option>
                <mat-option value="approved">อนุมัติแล้ว</mat-option>
                <mat-option value="rejected">ปฏิเสธ</mat-option>
            </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
            <mat-label>ประเภทคำร้อง</mat-label>
            <mat-select [ngModel]="typeFilter()" (ngModelChange)="typeFilter.set($event); onFilterChange()">
                <mat-option value="">ทั้งหมด</mat-option>
                <mat-option value="report_problem">แจ้งปัญหา</mat-option>
                <mat-option value="request_point">ขอจุดเก็บขยะใหม่</mat-option>
            </mat-select>
        </mat-form-field>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading()" class="loading-state">
        <mat-spinner diameter="40"></mat-spinner>
        <p>กำลังโหลดข้อมูล...</p>
    </div>

    <!-- Table Container -->
    <div class="table-container mat-elevation-z1" *ngIf="!loading()">
        <div class="table-scroll-wrapper">
            <table mat-table [dataSource]="data()">

                <!-- ID Column -->
                <ng-container matColumnDef="id">
                    <th mat-header-cell *matHeaderCellDef> ID </th>
                    <td mat-cell *matCellDef="let row"> #{{row.id}} </td>
                </ng-container>

                <!-- Type Column -->
                <ng-container matColumnDef="request_type">
                    <th mat-header-cell *matHeaderCellDef> ประเภท </th>
                    <td mat-cell *matCellDef="let row">
                        <span class="type-badge" [class.type-problem]="row.request_type === 'report_problem'"
                            [class.type-point]="row.request_type === 'request_point'">
                            {{ getRequestTypeName(row.request_type) }}
                        </span>
                    </td>
                </ng-container>

                <!-- Point Name Column -->
                <ng-container matColumnDef="point_name">
                    <th mat-header-cell *matHeaderCellDef> สถานที่ / จุด </th>
                    <td mat-cell *matCellDef="let row"> {{row.point_name || '-'}} </td>
                </ng-container>

                <!-- Note: Image Column Removed -->

                <!-- Created At Column -->
                <ng-container matColumnDef="created_at">
                    <th mat-header-cell *matHeaderCellDef> วันที่แจ้ง </th>
                    <td mat-cell *matCellDef="let row"> {{row.request_datetime | date:'dd/MM/yyyy HH:mm'}} </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef> สถานะ </th>
                    <td mat-cell *matCellDef="let row">
                        <span class="status-badge" [ngClass]="getStatusClass(row.status)">
                            {{ getStatusLabel(row.status) }}
                        </span>
                    </td>
                </ng-container>

                <!-- Reporter Column -->
                <ng-container matColumnDef="reporter">
                    <th mat-header-cell *matHeaderCellDef> ผู้แจ้ง </th>
                    <td mat-cell *matCellDef="let row">
                        <div class="flex flex-col text-sm">
                            <span>{{row.reporter_name || '-'}}</span>
                            <span class="text-gray-500 text-xs">{{row.reporter_contact}}</span>
                        </div>
                    </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef> จัดการ </th>
                    <td mat-cell *matCellDef="let row">
                        <button mat-stroked-button color="primary" (click)="openManageDialog(row)">
                            จัดการ
                        </button>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

                <!-- Empty Row -->
                <tr class="mat-row" *matNoDataRow>
                    <td class="mat-cell text-center py-4 text-gray-500" [attr.colspan]="displayedColumns.length">
                        ไม่พบข้อมูลคำร้อง
                    </td>
                </tr>

            </table>
        </div>

        <mat-paginator [length]="total()" [pageSize]="pageSize()" [pageSizeOptions]="[5, 10, 25, 100]"
            (page)="onPageChange($event)" aria-label="Select page">
        </mat-paginator>
    </div>
</div>